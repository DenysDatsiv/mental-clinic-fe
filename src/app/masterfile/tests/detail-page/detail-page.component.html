<div *ngIf="!data" class="spinner-wrapper">
  <p-progressSpinner aria-label="Loading" class="loading-spinner align-content-center"></p-progressSpinner>
</div>

<div *ngIf="data" class="mx-4 md:mx-1">

  <div *ngIf="!isTestCompleted">
    <h2 class="text-center mb-0">{{ data?.name }}</h2>
    <p-divider class="divider-max-width justify-content-center mx-auto"></p-divider>
  </div>

  <div *ngIf="!isTestCompleted" class="page-container">
    <div class="instruction-container">
      <div class="pb-2">
        <h2 class="section-title">üìå –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è</h2>
        <p class="section-text">{{ data?.instructions }}</p>
      </div>
      <div class="mb-0">
        <h3 class="section-subtitle">üîç –î–ª—è —á–æ–≥–æ —Ü–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è?</h3>
        <p class="section-text mb-0">{{ data?.whyTest }}</p>
      </div>
      <p-divider class="mx-1"></p-divider>
    </div>

    <div class="sm:w-full ld:mt-1 flex lg:align-items-center lg:justify-content-between flex-column lg:flex-row">
      <div class="d-flex">
        <div class="w-full flex align-items-center sm:justify-content-center">
          <button
            (click)="openPdf(data?.pdfLink)"
            *ngIf="data?.pdfLink !=='null'"
            class="p-button-danger p-button w-full lg:w-auto"
            icon="pi pi-file-pdf"
            label="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PDF —Ñ–∞–π–ª"
            pButton
            type="button">
          </button>
        </div>
      </div>
      <div>
        <div class="flex flex-column lg:flex-row lg:align-items-center mt-1 lg:mt-0 text-center">
          <p>–û–ø—Ç–∏–º–∞–ª—å–Ω–∏–π —á–∞—Å –¥–ª—è –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è:</p>
            <p-chip class="lg:ml-2 " [label]="data?.duration" icon="pi pi-clock"></p-chip>

        </div>
      </div>
    </div>

    <div class="quiz-container pt-3">
      <form>
        <div>
          <p *ngIf="data.questions[currentQuestionIndex]?.question" class="quiz-question">
            {{ currentQuestionIndex + 1 }}. {{ data.questions[currentQuestionIndex]?.question }}
          </p>

          <div *ngIf="data.questions[currentQuestionIndex]?.example" class="pb-2">
            <span>{{ data.questions[currentQuestionIndex]?.example }}</span>
          </div>

          <div [ngClass]="{'quiz-options': true, 'error-border': showError}">
            <div
              (click)="selectAnswer(data.questions[currentQuestionIndex]?._id, data.questions[currentQuestionIndex]?.value[i])"
              *ngFor="let label of data.questions[currentQuestionIndex]?.labelText; let i = index"
              class="quiz-option">

              <p-radioButton
                (onChange)="clearError()"
                [(ngModel)]="answers[data.questions[currentQuestionIndex]?._id]"
                [name]="'question_' + data.questions[currentQuestionIndex]?._id"
                [ngModelOptions]="{ standalone: true }"
                [value]="data.questions[currentQuestionIndex]?.value[i]"
                class="mr-3">
              </p-radioButton>

              <span>{{ label }}</span>
            </div>
          </div>
          <div class="mt-2">
            <p-message *ngIf="showError" severity="error"
                       text="–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –≤–∞—Ä—ñ–∞–Ω—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø–µ—Ä–µ–¥ —Ç–∏–º, —è–∫ –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—ñ."></p-message>
          </div>
        </div>
      </form>
    </div>

    <div
      [ngClass]="{'justify-content-end': currentQuestionIndex === 0, 'justify-content-between': currentQuestionIndex > 0}"
      class="flex my-5  ">
      <button
        (click)="previousQuestion()"
        *ngIf="currentQuestionIndex > 0"
        class="p-button-secondary"
        pButton
        type="button">
        –ù–∞–∑–∞–¥
      </button>

      <button
        (click)="nextQuestion()"
        class="p-button-primary "
        pButton
        type="button">
        {{ currentQuestionIndex < data.questions.length - 1 ? '–î–∞–ª—ñ' : '–ó–∞–≤–µ—Ä—à–∏—Ç–∏' }}
      </button>
    </div>
  </div>


  <div *ngIf="isTestCompleted" class="result-container">
    <ng-container *ngIf="data?.specialTest === specializedTests.SMI; else generalResult">
      <div class="ysq-container">
        <h2 class="text-center text-blue-600 font-bold text-3xl">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É YSQ-S3</h2>
        <p-divider class="divider-max-width justify-content-center mx-auto"></p-divider>

        <div class="schema-results grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
          <div *ngFor="let testName of Object.keys(schemaScores)" class="schema-container">
            <div class="schema-name">{{ testName }}</div>
            <div class="schema-info">
              <span class="schema-sum">–°–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è:</span>
              {{ schemaScores[testName] | number: '1.2-2' }}
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-template #generalResult>
      <div class="result-card">
        <h2 class="result-title  text-2xl font-bold text-center">üéâ –í–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ç–µ—Å—Ç üéâ</h2>

        <div class="score-box text-center my-4">
          <p class="score-text text-white text-lg">–í–∞—à–∞ —Å—É–º–∞ –±–∞–ª—ñ–≤:</p>
          <p class="score-value text-white text-4xl font-bold">{{ totalScore }}</p>
        </div>

        <p class="result-message text-center text-lg">{{ resultMessage }}</p>
        <p class="common-message text-gray-500 text-center">{{ data?.commonMessage }}</p>

        <div class="button-group flex flex-column justify-content-center mt-5 gap-3">
            <div class="flex justify-content-center mt-5 gap-3">
                <p-button (click)="restartTest()" label="–ü—Ä–æ–π—Ç–∏ –∑–Ω–æ–≤—É">
                </p-button>

                <p-button (click)="goToAllTests()" label="–î–æ –≤—Å—ñ—Ö —Ç–µ—Å—Ç—ñ–≤">
                </p-button>
            </div>

            <p-button (click)="openContacts()" label="–ó–∞–ø–∏—Å–∞—Ç–∏—Å—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é">
            </p-button>

        </div>
      </div>
    </ng-template>
  </div>
</div>
